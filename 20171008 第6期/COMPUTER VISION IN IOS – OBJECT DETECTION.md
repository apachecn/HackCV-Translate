# IOSä¸­çš„è®¡ç®—æœºè§†è§‰â€”â€”ç›®æ ‡æ£€æµ‹

åŸæ–‡é“¾æ¥ï¼š[COMPUTER VISION IN IOS â€“ OBJECT DETECTION](https://sriraghu.com/2017/07/12/computer-vision-in-ios-object-detection/?from=hackcv&hmsr=hackcv.com&utm_medium=hackcv.com&utm_source=hackcv.com)

## ä»€ä¹ˆæ˜¯ç›®æ ‡æ£€æµ‹ï¼Ÿ

åœ¨ä¹‹å‰ï¼Œæˆ‘å†™äº†ä¸€ç¯‡å«åšâ€œç›®æ ‡è¯†åˆ«â€çš„åšå®¢ï¼Œä»‹ç»äº†å¦‚ä½•ç”¨iPhoneå»å®ç°å®ƒã€‚ï¼ˆIOSä¸­çš„è®¡ç®—æœºè§†è§‰â€”â€”ç›®æ ‡æ£€æµ‹ï¼‰é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘å†™è¿™ç¯‡åšå®¢æ˜¯è¦ä»‹ç»äº›ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¼šæ¢è®¨ç›®æ ‡æ£€æµ‹ã€‚

åœ¨ç›®æ ‡è¯†åˆ«çš„é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è®­ç»ƒæ·±åº¦ç¥ç»ç½‘ç»œå»è¯†åˆ«åœ¨ä¸€å¼ å›¾ç‰‡ä¸­æ˜¯å¦æœ‰ç›®æ ‡ç‰©å“çš„å‡ºç°ã€‚åœ¨ç›®æ ‡æ£€æµ‹ä¸­ï¼Œæ·±åº¦ç¥ç»ç½‘ç»œä¸ä»…å¯ä»¥è¯†åˆ«å›¾ç‰‡ä¸­æœ‰ä»€ä¹ˆç‰©ä½“ï¼Œè¿˜å¯ä»¥æ£€æµ‹åˆ°å›¾ç‰‡å½“ä¸­ç›®æ ‡çš„å…·ä½“ä½ç½®ã€‚å¦‚æœå’ªè¡¨æ£€æµ‹å¯ä»¥è¢«åº”ç”¨äºå®æ—¶è¿è¡Œä¸­ï¼Œé‚£ä¹ˆåœ¨è‡ªåŠ¨é©¾é©¶æ–¹é¢çš„å¾ˆå¤šé—®é¢˜éƒ½å¯ä»¥å¾ˆå®¹æ˜“çš„è§£å†³ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿçš„äº†è§£ä»¥ä¸‹æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨Appleçš„æœºå™¨å­¦ä¹ æ¡†æ¶CoreMLï¼Œä»¥åŠå¦‚ä½•åœ¨iPhone7ä¸­å®ç°ç›®æ ‡æ£€æµ‹çš„appã€‚æˆ‘ä»¬å°†ä»ç†Ÿæ‚‰CoreMLçš„ç›¸å…³å·¥å…·å¼€å§‹ï¼Œè™½ç„¶è¿™ä¸€å¼€å§‹ä¼šä½¿ä½ æ„Ÿåˆ°æœ‰å¾ˆå¤šå›°æƒ‘ï¼Œä½†æ˜¯ä½ åªè¦æŒºè¿‡å»äº†å°±ä¼šæœ‰æ”¶è·ã€‚

Appleç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¥½çš„å·¥å…·ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ–¹ä¾¿çš„å°†ä»»æ„æ¨¡å‹ä»æˆ‘ä»¬é€‰æ‹©çš„åº“ä¸­è½¬æ¢ä¸ºCoreMLæ¨¡å‹ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘å¼€å§‹æ­£å¼ä»‹ç»è¿™ç¯‡åšå®¢çš„ä¸»è¦å†…å®¹å‰ï¼Œæˆ‘æƒ³å…ˆæ„Ÿè°¢CoreMLçš„å›¢é˜Ÿï¼Œå› ä¸ºä»–ä»¬ä½¿æˆ‘å°†ä¸€ä¸ªæœ¬æ¥æˆ‘ä»¥ä¸ºå¾—èŠ±ä¸€å¹´æ—¶é—´åšçš„é¡¹ç›®ï¼Œå˜æˆäº†ä¸€å‘¨å®Œæˆã€‚

è¿™ç¯‡åšå®¢çš„ä¸»è¦å†…å®¹æ˜¯å®æ—¶è¿è¡Œç›®æ ‡æ£€æµ‹ï¼ˆå†IPHONE7ä¸Šï¼‰å¹¶å¯ä»¥åµŒå…¥åˆ°é©¾é©¶åº”ç”¨ç¨‹åºä¸­ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘è¯´æˆ‘æƒ³è¦æ£€æµ‹å¯èƒ½å‡ºç°æˆ‘è½¦å‰çš„ç‰©ä½“æ—¶ï¼Œå¯èƒ½æ˜¯æ±½è½¦ã€è¡Œäººã€å¡è½¦ç­‰ã€‚è€Œç°åœ¨æˆ‘åªæƒ³æ£€æµ‹å…¶ä¸­çš„æ±½è½¦ã€‚å¤šäºäº†Udacityçš„è‡ªé©¾è½¦å¾®å­¦ä½çš„å¼€è®¾ï¼Œå› ä¸ºè¿™ä¸ªæœ‰å¾ˆå¤šå¾®å­¦ä½çš„é¡¹ç›®åœ¨githubä¸Šä¸ºå¼€æºé¡¹ç›®ã€‚

ç›®æ ‡æ£€æµ‹åœ¨æ·±åº¦å­¦ä¹ çš„æ¢ç´¢ä¸­å¸å¼•äº†å¾ˆå¤§çš„æ³¨æ„åŠ›ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šçš„è®ºæ–‡åœ¨æ¢è®¨è¿™ä¸ªè¯é¢˜ã€‚ç„¶è€Œä¸€äº›è®ºæ–‡ä»…ä»…å…³æ³¨äºå‡†ç¡®æ€§ï¼Œä¸€äº›è®ºæ–‡é›†ä¸­äºå®æ—¶è¿è¡Œçš„è¡¨ç°ã€‚å¦‚æœä½ æƒ³è¦è¿›ä¸€æ­¥äº†è§£è¿™ä¸ªé¢†åŸŸï¼Œä½ å¯ä»¥äº†è§£ä¸‹åˆ—æåŠçš„æ–¹é¢çš„è®ºæ–‡ï¼š R-CNN, Fast R-CNN, Faster R-CNN, YOLO, YOLO-9000, SSD, MobileNet SSDã€‚

### ä»€ä¹ˆæ˜¯æœ€å¥½çš„ç¥ç»ç½‘ç»œï¼Ÿ

æˆ‘åœ¨ä¸Šæ–‡æåˆ°äº†7ç§ä¸åŒçš„ç¥ç»ç½‘ç»œã€‚é‚£ä¹ˆä¸Šåˆ—çš„å“ªä¸ªç¥ç»ç½‘ç»œæœ€å¥½å®ç°ï¼ŸğŸ¤”è¿™æ˜¯ä¸ªå›°éš¾çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“ä½ ä¸æƒ³æµªè´¹ä½ çš„æ—¶é—´ç”¨æš´åŠ›æ–¹æ³•ç”¨å®ç°æ¯ä¸ªç¥ç»ç½‘ç»œè§‚å¯Ÿå®ƒçš„ç»“æœã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¯¹é€‰æ‹©æœ€å¥½çš„ç¥ç»ç½‘ç»œå®ç°åšä¸€äº›åˆ†æã€‚åœ¨ç›®æ ‡æ£€æµ‹çš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

- **é¢„å¤„ç†**ï¼šä»ç›¸æœºä¸­è·å–å›¾ç‰‡ï¼Œåœ¨å°†å…¶æ”¾å…¥ç¥ç»ç½‘ç»œå‰å…ˆè¿›è¡Œä¸€äº›å›¾åƒå¤„ç†ï¼ˆç¼©æ”¾å’Œè°ƒæ•´å¤§å°ï¼‰ã€‚
- **å¤„ç†**ï¼šè¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ã€‚æˆ‘ä»¬å°†é¢„å¤„ç†åçš„å›¾ç‰‡æ”¾å…¥CoreMLçš„æ¨¡å‹ä¸­ï¼Œç„¶åå¾—åˆ°å®ƒç”Ÿæˆçš„ç»“æœã€‚
- **åå¤„ç†**ï¼šç”±CoreMLæ¨¡å‹ç”Ÿæˆçš„ç»“æœå°†åœ¨MLMultiArrayä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°ç»„åšä¸€å®šçš„å¤„ç†å»å¾—åˆ°ç›®æ ‡çš„ä½ç½®ï¼Œè¿™å°±æ˜¯ä»–çš„é¢„æµ‹ç²¾åº¦ã€‚

å½“æˆ‘ä½¿ç”¨ç§»åŠ¨æ‰‹æœºæ—¶ï¼Œæˆ‘åº”è¯¥ä¼šå…³æ³¨äºå®æ—¶è¿è¡Œçš„ç¥ç»ç½‘ç»œã€‚æ‰€ä»¥ï¼Œæˆ‘å¯ä»¥åœæ­¢è€ƒè™‘é‚£äº›åœ¨GPUé…å¤‡çš„æœºå™¨ä¸Šä¸åœ¨æ­£ç¡®çš„FPSä¸Šæ‰§è¡Œçš„ç¥ç»ç½‘ç»œã€‚

### è§„åˆ™1ï¼š

å¦‚æœä¸€ä¸ªç¥ç»ç½‘ç»œå¯ä»¥åœ¨ç”µè„‘ï¼ˆGPUæˆ–è€…CPU)ä¸Šå®æ—¶è¿è¡Œ,é‚£ä¹ˆè¿™ä¸ªç¥ç»ç½‘ç»œå€¼å¾—ä¸€è¯•ã€‚

è¿™ä¸ªè§„åˆ™å¯ä»¥åœ¨ä¸Šé¢çš„é€‰æ‹©ä¸­å°†R-CNNå’ŒFast-RCNNå»é™¤äº†ã€‚è™½ç„¶ç°åœ¨è¿˜æœ‰5ç§ç¥ç»ç½‘ç»œï¼Œä½†æ˜¯ä»–ä»¬å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼šFaster R-CNN,YOLOå’ŒSSDã€‚å’ŒFsater R-CNNæ¯”èµ·æ¥ï¼ŒYOLOå’ŒSSDåœ¨å®æ—¶è¿è¡Œæ–¹é¢éƒ½è¡¨ç°çš„æ›´å¥½ã€‚ï¼ˆæ¯”è¾ƒè¿™äº›æ¨¡å‹çš„è¿è¡Œæ—¶é—´ã€‚ï¼‰ç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨ä¸¤ä¸ªä¸­åšé€‰æ‹©ï¼šæ˜¯YOLOè¿˜æ˜¯SSDå‘¢ã€‚æˆ‘åœ¨Appleçš„å¸‚åœºä¸ŠCoremltoolsç‰ˆæœ¬æ˜¯3.0çš„æ—¶å€™å¼€å§‹åšè¿™ä¸ªç›®æ ‡è¯†åˆ«çš„é¡¹ç›®ã€‚è¿™äº›è¿˜æ²¡æœ‰å¹¿æ³›é€‚ç”¨çš„æ–‡æ¡£ï¼Œè¿™è¢«æ”¯æŒKeras 1.2.2ä»¥åŠCaffe v1.0ã€‚CoreMLçš„å›¢é˜ŸæŒç»­çš„æ›´æ–°ç€coremltoolsï¼Œç›®å‰å®ƒå·²ç»åˆ°äº†Keras 2.0.4æ”¯æŒçš„v4.0,æ‰€ä»¥æˆ‘åº”è¯¥é€‰æ‹©ä¸€ä¸ªç¥ç»ç½‘ç»œæœ‰ç€ç®€å•çš„å±‚ï¼ˆåªæœ‰å·ç§¯ï¼‰ï¼Œè€Œä¸æ˜¯ç¹ççš„æ“ä½œï¼Œå¦‚å»å·ç§¯ã€æ‰©å¼ å·ç§¯å’Œæ·±åº¦å·ç§¯ã€‚è¿™æ ·åˆ†æä¸€ä¸‹ï¼ŒYOLOæˆ˜èƒœäº†æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„SSDã€‚

### YOLO â€“ You Only Look Once:

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¼šå®ç°Tiny YOLO v1.0,æˆ‘åœ¨å°†æ¥æœ‰æ—¶é—´è¿˜ä¼šå®ç°YOLO v2.0ã€‚è®©æˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸‹æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„Tiny YOLO v1åŒ…å«9ä¸ªå·ç§¯å±‚è€Œåæ¥3ä¸ªå…¨è¿æ¥å±‚ ï¼ŒåŒ…å«4500ä¸‡ä¸ªå‚æ•°ã€‚

![mode_yolo_plot](https://sriraghublog.files.wordpress.com/2017/07/mode_yolo_plot.jpg?w=700)

è¿™å’Œåªæœ‰1500ä¸‡å‚æ•°çš„Tiny Yolo v2.0ç›¸æ¯”å®ƒæ˜¾å¾—æœ‰äº›å¤§ã€‚è¿™ä¸ªç¥ç»ç½‘ç»œçš„è¾“å…¥æ˜¯ä¸€ä¸ª448Ã—448Ã—3RGBçš„å›¾åƒï¼Œè€Œè¾“å‡ºæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º1470çš„çŸ¢é‡ã€‚è¯¥çŸ¢é‡å¯ä»¥åˆ’åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼šæœ‰ä¸€å®šå¯èƒ½æ€§çš„ã€ç¡®å®šçš„ã€ç®±å½¢åæ ‡ç³»ã€‚è¿™ä¸‰ä¸ªéƒ¨åˆ†çš„å†…éƒ¨åˆå¯ä»¥åˆ’åˆ†ä¸º49ä¸ªå°çš„ä¸ªä½“å¯¹åº”äºå›¾åƒä¸Šçš„æ¯ä¸ªå•å…ƒçš„æ£€æµ‹ã€‚

![net_output](https://sriraghublog.files.wordpress.com/2017/07/net_output.png?w=700)

ç†è®ºå°±è¯´åˆ°è¿™é‡Œäº†ï¼Œç°åœ¨è®©æˆ‘ä»¬åŠ¨æ‰‹å†™ä»£ç ã€‚

**äº‹å…ˆå‡†å¤‡**ï¼šå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡è¯»è¿™ç¯‡åšå®¢ï¼Œè¯·å…ˆçœ‹æˆ‘å…ˆå‰çš„è¿™ç¯‡åšå®¢â€”[Computer Vision in iOS â€“ CoreML+Keras+MNIST](https://sriraghu.com/2017/07/06/computer-vision-in-ios-coremlkerasmnist/) â€”åœ¨ä½ çš„Macä¸Šå‡†å¤‡å¥½å·¥ä½œç¯å¢ƒã€‚å› ä¸ºè®­ç»ƒä¸€ä¸ªYOLOç½‘ç»œéœ€è¦è€—è´¹å¤§é‡çš„æ—¶é—´å’ŒåŠªåŠ›ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨é¢„å…ˆè®­ç»ƒçš„æƒé‡æ¥è®¾è®¡CoreML Tiny YOLO v1æ¨¡å‹ã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ª[é“¾æ¥](https://drive.google.com/file/d/0B1tW VtY7onibmdQWE1zVERxcjQ/view)ä¸‹è½½æƒé‡ã€‚

åœ¨ä½ ä»ä¸Šé¢çš„é“¾æ¥ä¸‹è½½äº†æƒé‡ä¹‹åï¼Œæ–°åˆ›å»ºä¸€ä¸ªéšæ„å‘½åçš„ä¸»ç›®å½•ï¼Œå¹¶å°†æ‚¨ä¸‹è½½çš„æƒé‡æ–‡ä»¶ç§»åˆ°è¯¥ç›®å½•ä¸‹ã€‚

- è®©æˆ‘ä»¬å¼•ç”¨ä¸€äº›å¿…è¦çš„åº“

```
# Import necessary libraries
import numpy as np
import matplotlib.pyplot as plt
%matplotlib inline
import cv2

import keras
from keras.models import Sequential
from keras.layers.convolutional import Conv2D, MaxPooling2D
from keras.layers.advanced_activations import LeakyReLU
from keras.layers.core import Flatten, Dense, Activation, Reshape
```

- å®šä¹‰ Tiny YOLO v1.0æ¨¡å‹

```
def yolo(shape):
    model = Sequential()
    model.add(Conv2D(16,(3,3),strides=(1,1),input_shape=shape,padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2)))
    model.add(Conv2D(32,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(64,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(128,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(256,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(512,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Flatten())
    model.add(Dense(256))
    model.add(Dense(4096))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Dense(1470))
    return model
```

- ç°åœ¨è®©æˆ‘ä»¬å†™ä¸€ä¸ªæœ‰ç”¨çš„æ–¹æ³•æŠŠæˆ‘ä»¬ä¸‹è½½çš„â€œyolo-tiny.weightsâ€æ–‡ä»¶ä¸­çš„æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­ã€‚

```
# Helper function to load weights from weights-file into YOLO model
def load_weights(model,yolo_weight_file):
    data = np.fromfile(yolo_weight_file,np.float32)
    data=data[4:]

    index = 0
    for layer in model.layers:
        shape = [w.shape for w in layer.get_weights()]
        if shape != []:
            kshape,bshape = shape
            bia = data[index:index+np.prod(bshape)].reshape(bshape)
            index += np.prod(bshape)
            ker = data[index:index+np.prod(kshape)].reshape(kshape)
            index += np.prod(kshape)
            layer.set_weights([ker,bia])
```

- æˆ‘ä»¬ä½¿ç”¨çš„é¢„å…ˆè®­ç»ƒå¥½çš„æƒé‡æ˜¯ä»¥Theanoä½œä¸ºå›¾åƒå°ºå¯¸å¤„ç†çš„åç«¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¿…é¡»è¦å°†Theanoè®¾ç½®ä¸ºåç«¯ï¼Œç„¶åå†æŠŠæƒé‡å€¼åŠ è½½åˆ°æ¨¡å‹ä¸­ã€‚

```
# Load the initial model
keras.backend.set_image_dim_ordering('th')
shape = (3,448,448)
model = yolo(shape)
print "Theano mode summary: \n",model.summary()
load_weights(model,'./yolo-tiny.weights')
```

### å±‚çš„å°ºå¯¸ï¼š

æˆ‘ä¸Šé¢æåˆ°çš„æ¨¡å‹æ˜¯ç¬¦åˆTheanoçš„å›¾ç‰‡å¤§å°æ’åºçš„ã€‚å¦‚æœä½ æƒ³çŸ¥é“è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Œé‚£ä¹ˆè®©æˆ‘ç»™ä½ ä»‹ç»ä¸€ä¸‹3Då¯è§†åŒ–ï¼ä¸€ä¸ªæ™®é€šçš„1Dä¿¡å·æ˜¯ç”¨çŸ¢é‡æˆ–è€…1Dçš„æ•°ç»„ï¼Œå…¶å°ºå¯¸å°±æ˜¯çŸ¢é‡æˆ–æ•°ç»„çš„é•¿åº¦ã€‚å›¾åƒå°±æ˜¯2Dæ•°ç»„æˆ–çŸ©é˜µè¡¨ç¤ºçš„ä¿¡å·ã€‚å›¾åƒçš„å°ºå¯¸ä¸ºçŸ©é˜µçš„å®½âœ–é«˜ã€‚å½“æˆ‘ä»¬æåˆ°å·ç§¯å±‚æ—¶ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨è®¨è®ºä¸‰ç»´çš„æ•°æ®ç»“æ„ã€‚å·ç§¯å±‚å°±æ˜¯äºŒç»´çŸ©é˜µçš„å åŠ è€Œæˆã€‚è¿™ä¸ªæ–°çš„å°ºå¯¸å«åšå±‚çš„æ·±åº¦ã€‚åšä¸ªç±»æ¯”ï¼ŒRGBå›¾åƒæ˜¯ä¸‰ä¸ªäºŒç»´çŸ©é˜µçš„ç»„åˆã€‚ï¼ˆå®½âœ–é«˜âœ–3ï¼‰åœ¨å›¾åƒä¸­æˆ‘ä»¬ç§°ä¹‹ä¸ºé€šé“ï¼Œè€Œåœ¨å·ç§¯å±‚ä¸­æˆ‘ä»¬ç§°ä¹‹ä¸ºæ·±åº¦ã€‚å¥½çš„ï¼Œè¿™å°±è§£é‡Šæ¸…æ¥šäº†ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è®¨è®ºå›¾ç‰‡å¤§å°æ’åºå‘¢?æ·±åº¦å­¦ä¹ ä¸­æœ‰ä¸¤ä¸ªä¸»è¦çš„åº“ï¼ŒTheanoå’ŒTensorFlowã€‚Kerasæ˜¯ç”±Theanoå’ŒTensorFlowæ„å»ºè€Œæˆçš„ï¼Œä½¿æˆ‘ä»¬èƒ½çµæ´»çš„è°ƒç”¨è¿™äº›åº“ã€‚Appleçš„coremltoolsæ”¯æŒKerasä»¥TensorFlowä½œä¸ºåç«¯ã€‚TensorFlowå¯¹äºå›¾ç‰‡å°ºå¯¸çš„å¤„ç†æ˜¯å®½âœ–é«˜âœ–æ·±åº¦ï¼Œè€ŒTheanoå¤„ç†å›¾ç‰‡å°ºå¯¸æ˜¯æ·±åº¦âœ–å®½âœ–é«˜ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³è¦å°†æˆ‘ä»¬çš„æ¨¡å‹ä»ä»¥Theanoä¸ºåç«¯çš„Keraså˜æˆCoreMLçš„æ¨¡å‹ã€‚ä½ é¦–å…ˆéœ€è¦å°†åç«¯å˜æˆTensorFlowã€‚å½“æˆ‘ä»¬è€ƒè™‘å›¾ç‰‡å°ºå¯¸å’Œæƒé‡çŸ©é˜µå°ºå¯¸æ—¶ä¼šå‘ç°é—®é¢˜å¾ˆå¤æ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å°†è¿™äº›æƒé‡å€¼æ”¾åˆ°å¦ä¸€ä¸ªæ¨¡å‹Keras2.0.4.æ—¶é—®é¢˜å°±å¾ˆå¥½è§£å†³äº†ã€‚

çœŸæ­£çš„æŒ‘æˆ˜æ˜¯å°†è¿™ä¸ªæ¨¡å‹çš„åç«¯ä»theanoè½¬åŒ–ä¸ºtensorflowï¼Œè¿™ä¸€æ­¥è¿›è¡Œçš„å¹¶ä¸é¡ºåˆ©ã€‚å¹¸è¿çš„æ˜¯æˆ‘æ‰¾åˆ°äº†æ›´å¥½çš„ä»£ç èƒ½å°†æƒé‡ä»theanoå±‚è½¬åŒ–ä¸ºtensorflowå±‚ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿæ¨¡å‹ä¼šå‘ç°ï¼Œå®ƒæ˜¯å·ç§¯å±‚å’Œå…¨è¿æ¥å±‚çš„ç»„åˆã€‚æ‰€ä»¥ï¼Œåœ¨æ¥å…¥å…¨è¿æ¥å±‚ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å°†å·ç§¯å±‚çš„ç»“æœå‹å¹³ã€‚è¿™ä¸ªé—®é¢˜ååˆ†å›°éš¾ï¼Œæˆ‘ä»¬ä¸èƒ½è‡ªåŠ¨åŒ–ç”Ÿæˆï¼Œé™¤éæˆ‘ä»¬çš„å¤§è„‘èƒ½å¤Ÿè½»æ˜“çš„å¯è§†åŒ–3Då’Œ4Dç»´åº¦ã€‚ä¸ºäº†èƒ½å¤Ÿç®€å•å®¹æ˜“çš„è¿›è¡Œè°ƒè¯•ï¼Œè®©æˆ‘ä»¬æŠŠè¿™ä¸€ä¸ªæ¨¡å‹åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚

- **ç¬¬ä¸€éƒ¨åˆ†**â€”åŒ…å«æ‰€æœ‰çš„å·ç§¯å±‚ã€‚
- **ç¬¬äºŒéƒ¨åˆ†**â€”åŒ…å«ä½¿ç¬¬ä¸€éƒ¨åˆ†è¾“å‡ºç»“æœå¹³å¦åŒ–çš„æ‰€æœ‰æ“ä½œã€‚
- **ç¬¬ä¸‰éƒ¨åˆ†**â€”åŒ…å«å°†ç¬¬äºŒéƒ¨åˆ†çš„ç»“æœæ¥å…¥å…¨è¿æ¥å±‚ã€‚

è®©æˆ‘ä»¬å…ˆå®šä¹‰æ¨¡å‹çš„ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬ä¸‰éƒ¨åˆ†ã€‚

```
# YOLO Part 1
def yoloP1(shape):
    model = Sequential()
    model.add(Conv2D(16,(3,3),strides=(1,1),input_shape=shape,padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2)))
    model.add(Conv2D(32,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(64,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(128,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(256,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(512,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(MaxPooling2D(pool_size=(2, 2),padding='valid'))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Conv2D(1024,(3,3),padding='same'))
    model.add(LeakyReLU(alpha=0.1))
    return model

# YOLO Part 3
def yoloP3():
    model = Sequential()
    model.add(Dense(256,input_shape=(50176,)))
    model.add(Dense(4096))
    model.add(LeakyReLU(alpha=0.1))
    model.add(Dense(1470))
    return model
```

- è®©æˆ‘ä»¬ç”¨å°†TensorFlowä¸ºåç«¯çš„Kerasåˆå§‹åŒ–ä¸‰ä¸ªç½‘ç»œã€‚ä»–ä»¬åˆ†åˆ«ä½¿ï¼šYOLO ç¬¬ä¸€éƒ¨ï¼ˆmodel_p1ï¼‰,YOLO ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆmodel_p3ï¼‰ä»¥åŠYOLO Full(model_full)ã€‚åŒæ—¶ä¸ºäº†æµ‹è¯•è¿™å‡ ä¸ªç½‘ç»œæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬åŒæ—¶å®šä¹‰ç¬¬ä¸€å’Œç¬¬ä¸‰éƒ¨åˆ†æ¨¡å‹ç”¨Theanoä½œä¸ºåç«¯ã€‚

```
# Let us get Theano backend edition of Yolo Parts 1 and 3
model_p1_th = yoloP1(shape)
model_p3_th = yoloP3()
# Tensorflow backend edition
keras.backend.set_image_dim_ordering('tf')
shape = (448,448,3)
model_p1 = yoloP1(shape)
model_p3 = yoloP3()
model_full = yolo(shape)
```

- åœ¨å‰é¢æˆ‘ä»¬å·²ç»æåˆ°äº†ä»¥Theanoå’ŒTensorFlowä¸ºåç«¯çš„å·ç§¯å±‚çš„å›¾ç‰‡å°ºå¯¸ä¸åŒã€‚æ‰€ä»¥è®©æˆ‘ä»¬å†™ä¸€ä¸ªç¨‹åºå°†Theano â€˜modelâ€™çš„æƒé‡è½¬åŒ–ä¸ºTensorFlowçš„â€œmodel_fullâ€ã€‚

```
# Transfer weights from Theano model to TensorFlow model_full
for th_layer,tf_layer in zip(model.layers,model_full.layers):
    if th_layer.__class__.__name__ == 'Convolution2D':
        kernel, bias = th_layer.get_weights()
        kernel = np.transpose(kernel,(2,3,1,0))
        tf_layer.set_weights([kernel,bias])
    else:
        tf_layer.set_weights(th_layer.get_weights())
```

- åœ¨è¿›è¡Œä¸‹ä¸ªé˜¶æ®µå‰ï¼Œè®©æˆ‘ä»¬ç®€å•çš„æµ‹è¯•ä¸€ä¸‹æ˜¯å¦Theanoçš„'model'å’ŒTensorFlowçš„â€œmodel_fullâ€çš„ç»“æœæ˜¯å¦ä¸€è‡´ã€‚ä¸ºäº†è¾¾åˆ°è¿™æ ·çš„ç›®çš„ï¼Œæˆ‘ä»¬è¯»å–ä¸€å¼ å›¾ç‰‡ï¼Œå¤„ç†å®ƒï¼Œç„¶åå°†å®ƒæ”¾å…¥æ¨¡å‹ä¸­å¹¶é¢„æµ‹å®ƒçš„è¾“å‡ºç»“æœã€‚

```
# Read an image and pre-process it
im = cv2.imread('test1.jpg')
plt.imshow(im[:,:,::-1])
plt.show()
im = cv2.resize(im,(448,448))
im = 2*im.astype(np.float32)/255. - 1
im = np.reshape(im,(1,448,448,3))
im_th = np.transpose(im,(0,3,1,2))

# Theano
output_th = model.predict(im_th)
# TensorFlow
output_tf = model_full.predict(im)

# Distance between two predictions
print 'Difference between two outputs:\nSum of Difference =', np.sum(output_th-output_tf),'\n2-norm of difference =',np.linalg.norm(output_th-output_tf)
```

- é€šè¿‡è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘å‘ç°å¯¹äºåŒä¸€å¼ å›¾ç‰‡ï¼Œtheanoå’Œtensorflowçš„è¾“å‡ºç»“æœæœ‰å¾ˆå¤§çš„ä¸åŒã€‚å¦‚æœè¾“å‡ºç»“æœä¸€è‡´çš„è¯ï¼Œâ€œSum of Differenceâ€å’Œâ€œ2-norm of differenceâ€åº”è¯¥ç­‰äº0ã€‚
- æ—¢ç„¶ç›´æ¥è½¬æ¢æ²¡æœ‰ç”¨ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬è½¬å‘æ¨¡å‹éƒ¨ä»¶çš„è®¾è®¡ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»Tiny YOLO çš„ç¬¬ä¸€éƒ¨åˆ†å¼€å§‹ã€‚

```
# Theano
model_p1_th.layers[0].set_weights(model.layers[0].get_weights())
model_p1_th.layers[3].set_weights(model.layers[3].get_weights())
model_p1_th.layers[6].set_weights(model.layers[6].get_weights())
model_p1_th.layers[9].set_weights(model.layers[9].get_weights())
model_p1_th.layers[12].set_weights(model.layers[12].get_weights())
model_p1_th.layers[15].set_weights(model.layers[15].get_weights())
model_p1_th.layers[18].set_weights(model.layers[18].get_weights())
model_p1_th.layers[20].set_weights(model.layers[20].get_weights())
model_p1_th.layers[22].set_weights(model.layers[22].get_weights())

# TensorFlow
model_p1.layers[0].set_weights(model_full.layers[0].get_weights())
model_p1.layers[3].set_weights(model_full.layers[3].get_weights())
model_p1.layers[6].set_weights(model_full.layers[6].get_weights())
model_p1.layers[9].set_weights(model_full.layers[9].get_weights())
model_p1.layers[12].set_weights(model_full.layers[12].get_weights())
model_p1.layers[15].set_weights(model_full.layers[15].get_weights())
model_p1.layers[18].set_weights(model_full.layers[18].get_weights())
model_p1.layers[20].set_weights(model_full.layers[20].get_weights())
model_p1.layers[22].set_weights(model_full.layers[22].get_weights())

# Theano
output_th = model_p1_th.predict(im_th)
# TensorFlow
output_tf = model_p1.predict(im)

# Dimensions of output_th and output_tf are different, so apply transpose on output_th
output_thT = np.transpose(output_th,(0,2,3,1))

# Distance between two predictions
print 'Difference between two outputs:\nSum of Difference =', np.sum(output_thT-output_tf),'\n2-norm of difference =',np.linalg.norm(output_thT-output_tf)
```

- é€šè¿‡è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸¤ä¸ªçš„è¾“å‡ºå®Œå…¨åŒ¹é…ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æˆåŠŸçš„å®Œæˆäº†æˆ‘ä»¬æ¨¡å‹ç¬¬ä¸€éƒ¨åˆ†çš„è®¾è®¡ï¼ç°åœ¨è®©æˆ‘ä»¬å»è®¾è®¡æ¨¡å‹çš„ç¬¬ä¸‰éƒ¨åˆ†ã€‚é€šè¿‡ä»”ç»†çš„è§‚å¯Ÿmodel_p3å’Œmodel_p3_thçš„æƒ…å†µï¼Œæˆ‘ä»¬å®¹æ˜“å‘ç°è¿™ä¸¤ç§æ¨¡å‹æ˜¯ç±»ä¼¼çš„ã€‚å› æ­¤ï¼Œå¯¹äºç»™å®šçš„è¾“å…¥ï¼Œä¸¤ä¸ªæ¨¡å‹éƒ½ä¼šç»™æˆ‘ä»¬ç›¸åŒçš„å›ºå®šè¾“å‡ºã€‚ä½†æ˜¯è¿™äº›æ¨¡å‹çš„è¾“å…¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç†æƒ³æƒ…å†µä¸‹çš„è¾“å…¥åº”è¯¥æ˜¯æ¥è‡ªYoloçš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä½†æ˜¯Yoloçš„ç¬¬äºŒéƒ¨åˆ†åªæ˜¯ä¸€ä¸ªç»™ä»»æ„å¤šç»´çš„è¾“å…¥å®ƒçš„è¾“å‡ºç»“æœéƒ½æ˜¯ä¸€ä¸ªä¸€ç»´çŸ¢é‡ã€‚å‡è®¾æˆ‘ä»¬å·²ç»åºåˆ—åŒ–äº†model_p1_thçš„è¾“å‡ºï¼Œé‚£ä¹ˆmodel_p3å’Œmodel_p3_thä¼šç»™æˆ‘ä»¬ç›¸ä¼¼çš„ç»“æœã€‚

```
# Theano
model_p3_th.layers[0].set_weights(model.layers[25].get_weights())
model_p3_th.layers[1].set_weights(model.layers[26].get_weights())
model_p3_th.layers[3].set_weights(model.layers[28].get_weights())

# TensorFlow
model_p3.layers[0].set_weights(model_full.layers[25].get_weights())
model_p3.layers[1].set_weights(model_full.layers[26].get_weights())
model_p3.layers[3].set_weights(model_full.layers[28].get_weights())

# Design the input
input_p3 = np.reshape(np.ndarray.flatten(output_th),(1,50176))

# Theano
output_th = model_p3_th.predict(input_p3)
# TensorFlow
output_tf = model_p3.predict(input_p3)

# Distance between two predictions
print 'Difference between two outputs:\nSum of Difference =', np.sum(output_th-output_tf),'\n2-norm of difference =',np.linalg.norm(output_th-output_tf)
```

- åœ¨è¿è¡Œä¸Šé¢çš„ä»£ç æ—¶æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°model_p3å’Œmodel_p3_thç»™äº†æˆ‘ä»¬ä¸€æ ·çš„ç»“æœã€‚
- YOLOçš„ç¬¬äºŒéƒ¨åˆ†åœ¨å“ªé‡Œï¼Ÿè€å¿ƒäº›ï¼Œæˆ‘ä»¬ç°åœ¨å°±è¦è®¾è®¡å®ƒäº†ã€‚åœ¨è®¾è®¡YOLOç¬¬äºŒéƒ¨åˆ†å‰ï¼Œè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹ç»´åº¦ã€‚æˆ‘å·²ç»æè¿‡äº†YOLOçš„ç¬¬äºŒéƒ¨åˆ†åªæ˜¯ä¸€ä¸ªç®€å•çš„å¹³å¦åŒ–çš„å±‚ã€‚æ˜¯ä»€ä¹ˆä½¿è¿™å˜å¾—å›°éš¾ï¼Ÿå¦‚æœä½ è¿˜è®°å¾—çš„è¯ï¼Œæ•´ä¸ªç½‘ç»œéƒ½æ˜¯ä»¥Theanoä¸ºåç«¯è®¾è®¡çš„ï¼Œåªæœ‰è¿™äº›æƒé‡å€¼éœ€è¦æˆ‘ä»¬çš„æ¨¡å‹ä»¥Tensorflowä¸ºåç«¯ã€‚ä¸ºäº†æ›´å¥½çš„ç†è§£flattenå±‚çš„æ“ä½œï¼Œæˆ‘å†™äº†ä¸€äº›ä»£ç è®©ä½ å»ç†è§£ã€‚é€šè¿‡è¿è¡Œä¸‹åˆ—ä»£ç ä½ ä¼šæ‰¾åˆ°æˆ‘ä»¬çš„model_fullç»™å‡ºçš„ç»“æœæ¯”modelç»™å‡ºçš„ç»“æœå¥‡æ€ªçš„åŸå› ã€‚

```
# Let us build a simple 3(width) x 3(height) x 3(depth) matrix and assume it as an output from Part 1
A = np.reshape(np.asarray([i for i in range(1,10)]),(3,3))
B = A + 10
C = A + 100

print 'A =\n',A,'\n\nB =\n',B,'\n\nC =\n',C

part1_output_tf = np.dstack((A,B,C))
print '\n\nTensorFlow\'s model_p1 output (assume) = \n',part1_output_tf

part1_output_th = np.transpose(part1_output_tf,(2,0,1))
print '\n\nTheano\'s model_p1_th output (assume) = \n',part1_output_th

print '\n\nDesired input for model_p3 =\n', part1_output_th.flatten()
print '\n\nActual input for model_p3 =\n', part1_output_tf.flatten()
```

- ç°åœ¨æˆ‘ä»¬äº†è§£äº†flattenå±‚çš„åº”ç”¨ä¸åƒæˆ‘ä»¬é¢„æƒ³çš„é‚£ä¹ˆå®¹æ˜“ã€‚ä¸‹é¢æœ‰ä¸€äº›æ–¹æ³•å…³äºæˆ‘ä»¬åº”è¯¥å¦‚ä½•å®ç°å¹³å¦åŒ–å±‚ã€‚
  - **æƒ³æ³•1**â€”è·å–ç¬¬ä¸€éƒ¨åˆ†çš„è¾“å‡ºä½œä¸ºMLMultArrayï¼Œå¹¶åœ¨IOSåº”ç”¨ç¨‹åºçš„CPUä¸Šåº”ç”¨è‡ªå®šä¹‰çš„å¹³å¦åŒ–æ“ä½œã€‚æ“ä½œçš„æ¶ˆè€—å¤ªå¤§äº†ï¼
  - **æƒ³æ³•2**â€”ä½¿ç”¨Kerasè®¾ç½®ä¸€ä¸ªä»¥ Permute å±‚åŠ ä¸ŠFlattenå±‚çš„æ¨¡å‹å¹¶å°†å®ƒè½¬åŒ–ä¸ºCoreMLæ¨¡å‹ã€‚å¦‚æœå¯ä»¥åšåˆ°å°±è®¾è®¡æˆä¸€ä¸ªå•ä¸€çš„æ¨¡å‹ã€‚
  - **æƒ³æ³•3**â€”